---
import type { CollectionEntry } from "astro:content";
import BookmarkIcon from "../icons/Bookmark.astro";
import Share2Icon from "../icons/Share2.astro";
import type { Lang } from "../utils/i18n";
import {
  getLocalizedUrl,
  getLangFromUrl,
  useTranslations,
} from "../utils/i18n";
import question1 from "../assets/question1.svg";
import question2 from "../assets/question2.svg";
import question3 from "../assets/question3.svg";
import answer1 from "../assets/answer1.svg";
import answer2 from "../assets/answer2.svg";
import answer3 from "../assets/answer3.svg";
import answer4 from "../assets/answer4.svg";
import answer5 from "../assets/answer5.svg";

interface Props {
  gag: CollectionEntry<"gags">;
  lang?: Lang;
  showRandomButton?: boolean;
}

// lang propì´ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ URLì—ì„œ ì–¸ì–´ ê°ì§€
const detectedLang = getLangFromUrl(Astro.url);
const {
  gag,
  lang = detectedLang,
  showRandomButton = false,
} = Astro.props;
const t = useTranslations(lang);

// ëœë¤ ì•„ì´ì½˜ ì„ íƒ
const questionIcons = [question1, question2, question3];
const answerIcons = [answer1, answer2, answer3, answer4, answer5];
const randomQuestionIcon =
  questionIcons[Math.floor(Math.random() * questionIcons.length)];
const randomAnswerIcon =
  answerIcons[Math.floor(Math.random() * answerIcons.length)];
---

<div
  class="bg-card border-border rounded-lg border-2 p-6 shadow-lg md:p-8"
  data-gag-slug={gag.data.slug}
>
  <!-- íƒœê·¸ì™€ ë²„íŠ¼ -->
  <div class="mb-6 flex items-start justify-between gap-2">
    <div class="flex min-w-0 flex-1 flex-wrap gap-2">
      {
        gag.data.tags.map((tag: string) => (
          <a
            href={getLocalizedUrl(`/tags/${tag}`, lang)}
            class="bg-primary/10 text-primary hover:bg-primary/20 inline-block rounded-full px-3 py-1 text-sm font-medium transition-colors"
          >
            #{tag}
          </a>
        ))
      }
    </div>
    <div class="flex flex-shrink-0 items-center gap-2">
      <button
        class="save-btn hover:bg-accent rounded-md p-2 transition-colors"
        data-gag={JSON.stringify({
          slug: gag.data.slug,
          title: gag.data.title,
          description: gag.data.description,
          tags: gag.data.tags,
        })}
        aria-label={t("ì €ì¥", "Save")}
      >
        <BookmarkIcon class="bookmark-icon h-5 w-5" />
        <BookmarkIcon
          class="bookmark-check-icon text-primary hidden h-5 w-5"
          fill="currentColor"
        />
      </button>
      <button
        class="share-btn hover:bg-accent rounded-md p-2 transition-colors"
        data-content={`${gag.data.title}${gag.data.description ? " - " + gag.data.description : ""}`}
        data-slug={gag.data.slug}
        aria-label={t("ê³µìœ ", "Share")}
      >
        <Share2Icon size={20} />
      </button>
    </div>
  </div>

  <!-- ì§ˆë¬¸ ì œëª© -->
  <h3 class="text-foreground mb-6 text-center text-xl font-bold md:text-2xl">
    {gag.data.title}
  </h3>

  <!-- ì•„ì´ì½˜ ì „í™˜ (ì§ˆë¬¸ â†’ ì •ë‹µ) -->
  <div class="mb-6 flex justify-center">
    <div class="relative h-48 w-48 md:h-64 md:w-64">
      <img
        src={randomQuestionIcon.src}
        alt="Question"
        class="question-icon absolute inset-0 h-full w-full transition-opacity duration-500"
      />
      {
        gag.data.description && (
          <img
            src={randomAnswerIcon.src}
            alt="Answer"
            class="answer-icon absolute inset-0 h-full w-full opacity-0 transition-opacity duration-500"
          />
        )
      }
    </div>
  </div>

  <!-- ì •ë‹µ (í´ë¦­í•˜ë©´ í‘œì‹œ) -->
  {
    gag.data.description && (
      <div class="mb-6">
        <p
          class="answer-text text-foreground cursor-pointer text-center text-lg font-bold transition-all hover:scale-105 md:text-xl"
          data-answer={gag.data.description}
          title={t("í´ë¦­í•˜ì—¬ ë‹µë³€ ë³´ê¸°", "Click to reveal answer")}
        >
          <span class="answer-label text-muted-foreground">
            {t("ì •ë‹µ:", "Answer:")}
          </span>
          <span class="answer-content text-muted-foreground font-mono tracking-wider">
            {gag.data.description.replace(/[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]/g, "â—")}
          </span>
        </p>
      </div>
    )
  }

  <!-- ë²„íŠ¼ -->
  <div class="flex w-full flex-col gap-3 sm:flex-row sm:items-center">
    <a
      href={getLocalizedUrl(`/gags/${gag.data.slug}`, lang)}
      class="bg-primary text-primary-foreground hover:bg-primary/90 w-full rounded-lg px-4 py-3 text-center text-sm font-medium transition-colors sm:flex-1 sm:px-6"
    >
      {t("ìì„¸íˆ ë³´ê¸°", "View Details")}
    </a>
    {
      showRandomButton && (
        <button class="random-gag-btn border-border hover:bg-accent w-full rounded-lg border px-4 py-3 text-sm font-medium transition-colors sm:flex-1 sm:px-6">
          {t("ğŸ² ë‹¤ë¥¸ ê°œê·¸", "ğŸ² Random")}
        </button>
      )
    }
  </div>
</div>

<script>
  import { initGagInteractions } from "../scripts/gagInteractions";

  // ê°œê·¸ ìƒí˜¸ì‘ìš© ì´ˆê¸°í™” (ë¶ë§ˆí¬, ê³µìœ  ë“±)
  initGagInteractions();

  // ì •ë‹µ ê³µê°œ ê¸°ëŠ¥
  document.addEventListener("astro:page-load", () => {
    const initAnswerReveal = () => {
      const cards = document.querySelectorAll("[data-gag-slug]");

      cards.forEach((card) => {
        const answerText = card.querySelector(
          ".answer-text",
        ) as HTMLParagraphElement;
        const answerLabel = card.querySelector(
          ".answer-label",
        ) as HTMLSpanElement;
        const answerContent = card.querySelector(
          ".answer-content",
        ) as HTMLSpanElement;
        const questionIcon = card.querySelector(
          ".question-icon",
        ) as HTMLImageElement;
        const answerIcon = card.querySelector(
          ".answer-icon",
        ) as HTMLImageElement;

        if (!answerText || !answerContent) {
          return;
        }

        // ì¤‘ë³µ ë°©ì§€
        if (answerText.hasAttribute("data-initialized")) {
          return;
        }
        answerText.setAttribute("data-initialized", "true");

        // ë‹µë³€ í…ìŠ¤íŠ¸ í´ë¦­ ì‹œ ë‹µë³€ ê³µê°œ
        answerText.addEventListener("click", async () => {
          const fullAnswer = answerText.getAttribute("data-answer");
          if (!fullAnswer) {
            return;
          }

          // í´ë¦­ ì´ë²¤íŠ¸ ì œê±° (í•œ ë²ˆë§Œ ì‹¤í–‰)
          answerText.style.cursor = "default";
          answerText.style.pointerEvents = "none";

          // ì•„ì´ì½˜ ì „í™˜: question â†’ answer
          if (questionIcon && answerIcon) {
            questionIcon.style.opacity = "0";
            answerIcon.style.opacity = "1";
          }

          // íƒ€ì´í•‘ íš¨ê³¼
          answerContent.textContent = "";
          answerContent.classList.remove("text-muted-foreground");
          answerContent.classList.add("text-primary");

          // ë ˆì´ë¸” ìƒ‰ìƒë„ ë³€ê²½
          if (answerLabel) {
            answerLabel.classList.remove("text-muted-foreground");
            answerLabel.classList.add("text-primary");
          }

          // íƒ€ì´í•‘ íš¨ê³¼ë¡œ ë‹µë³€ í‘œì‹œ
          for (let i = 0; i < fullAnswer.length; i++) {
            await new Promise((resolve) => setTimeout(resolve, 50));
            answerContent.textContent = fullAnswer.substring(0, i + 1);
          }
        });
      });
    };

    initAnswerReveal();
  });

  // ëœë¤ ê°œê·¸ ë¡œë“œ ê¸°ëŠ¥
  document.addEventListener("astro:page-load", () => {
    const initRandomGag = () => {
      const randomButtons = document.querySelectorAll(".random-gag-btn");

      randomButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          try {
            const response = await fetch("/api/gags.json");
            const gags = await response.json();

            if (gags.length === 0) return;

            const cardElement = button.closest("[data-gag-slug]");
            if (!cardElement) return;

            const currentSlug = cardElement.getAttribute("data-gag-slug");
            const otherGags = gags.filter(
              (gag: any) => gag.slug !== currentSlug,
            );
            const randomGag =
              otherGags[Math.floor(Math.random() * otherGags.length)];

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” ë™ì  ì—…ë°ì´íŠ¸
            window.location.reload();
          } catch (error) {
            console.error("Failed to load random gag:", error);
          }
        });
      });
    };

    initRandomGag();
  });
</script>
