---
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import BookmarkIcon from "../icons/Bookmark.astro";
import Share2Icon from "../icons/Share2.astro";
import type { Lang } from "../utils/i18n";
import {
  getLocalizedUrl,
  getLangFromUrl,
  useTranslations,
} from "../utils/i18n";
import { tagToSlug } from "../utils/tagUtils";
import Q01 from "../assets/Q01.png";
import Q02 from "../assets/Q02.png";
import Q03 from "../assets/Q03.png";
import Q04 from "../assets/Q04.png";
import Q05 from "../assets/Q05.png";
import Q06 from "../assets/Q06.png";
import Q07 from "../assets/Q07.png";
import Q08 from "../assets/Q08.png";
import Q09 from "../assets/Q09.png";
import Q10 from "../assets/Q10.png";
import A01 from "../assets/A01.png";
import A02 from "../assets/A02.png";
import A03 from "../assets/A03.png";
import A04 from "../assets/A04.png";
import A05 from "../assets/A05.png";
import A06 from "../assets/A06.png";
import A07 from "../assets/A07.png";
import A08 from "../assets/A08.png";
import A09 from "../assets/A09.png";
import A10 from "../assets/A10.png";
import A11 from "../assets/A11.png";
import A12 from "../assets/A12.png";

interface Props {
  gag: CollectionEntry<"gags">;
  lang?: Lang;
  featured?: boolean;
}

// lang prop이 제공되지 않으면 URL에서 언어 감지
const detectedLang = getLangFromUrl(Astro.url);
const { gag, lang = detectedLang, featured = false } = Astro.props;
const t = useTranslations(lang);

// 랜덤 아이콘 선택
const questionImages = [Q01, Q02, Q03, Q04, Q05, Q06, Q07, Q08, Q09, Q10];
const answerImages = [
  A01,
  A02,
  A03,
  A04,
  A05,
  A06,
  A07,
  A08,
  A09,
  A10,
  A11,
  A12,
];
const randomQuestionImage =
  questionImages[Math.floor(Math.random() * questionImages.length)];
const randomAnswerImage =
  answerImages[Math.floor(Math.random() * answerImages.length)];
---

<article
  class="bg-card border-border rounded-lg border-2 p-6 shadow-lg md:p-8"
  data-gag-slug={gag.data.slug}
>
  <!-- 태그와 버튼 -->
  <header class="mb-6 flex items-start justify-between gap-2">
    <nav class="flex min-w-0 flex-1 flex-wrap gap-2" aria-label="Tags">
      {
        gag.data.tags.map((tag: string) => (
          <a
            href={getLocalizedUrl(`/tags/${tagToSlug(tag)}`, lang)}
            class="bg-primary/10 text-primary hover:bg-primary/20 inline-block rounded-full px-3 py-1 text-sm font-medium transition-colors"
          >
            #{tag}
          </a>
        ))
      }
    </nav>
    <div class="flex flex-shrink-0 items-center gap-2">
      <button
        class="save-btn hover:bg-accent rounded-md p-2 transition-colors"
        data-gag={JSON.stringify({
          slug: gag.data.slug,
          title: gag.data.title,
          description: gag.data.description,
          tags: gag.data.tags,
        })}
        aria-label={t("저장", "Save")}
      >
        <BookmarkIcon class="bookmark-icon h-5 w-5" />
        <BookmarkIcon
          class="bookmark-check-icon text-primary hidden h-5 w-5"
          fill="currentColor"
        />
      </button>
      <button
        class="share-btn hover:bg-accent rounded-md p-2 transition-colors"
        data-content={`${gag.data.title}${gag.data.description ? " - " + gag.data.description : ""}`}
        data-slug={gag.data.slug}
        aria-label={t("공유", "Share")}
      >
        <Share2Icon size={20} />
      </button>
    </div>
  </header>

  <!-- 질문 제목 -->
  <h3
    class="text-foreground mb-6 text-center text-2xl font-bold md:text-3xl"
    data-pagefind-body
  >
    {gag.data.title}
  </h3>

  <!-- 아이콘 전환 (질문 → 정답) -->
  <figure class="mb-6 flex justify-center">
    <div
      class="answer-trigger relative h-48 w-48 cursor-pointer transition-transform hover:scale-105 md:h-64 md:w-64"
      title={t("클릭하여 답변 보기", "Click to reveal answer")}
    >
      <Image
        src={randomQuestionImage}
        alt="Question"
        class="question-icon absolute inset-0 h-full w-full rounded-full object-contain transition-opacity duration-500"
      />
      {
        gag.data.description && (
          <Image
            src={randomAnswerImage}
            alt="Answer"
            class="answer-icon absolute inset-0 h-full w-full rounded-full object-contain opacity-0 transition-opacity duration-500"
          />
        )
      }
    </div>
  </figure>

  <!-- 정답 (클릭하면 표시) -->
  {
    gag.data.description && (
      <section class="mb-6">
        <p
          class="answer-text text-foreground cursor-pointer text-center text-2xl font-bold transition-all hover:scale-105 md:text-3xl"
          data-answer={gag.data.description}
          title={t("클릭하여 답변 보기", "Click to reveal answer")}
        >
          <span class="answer-content text-muted-foreground font-mono tracking-wider">
            {gag.data.description.replace(/[가-힣ㄱ-ㅎㅏ-ㅣa-zA-Z0-9]/g, "●")}
          </span>
        </p>
      </section>
    )
  }

  <!-- 버튼 -->
  <footer class="mt-8 flex w-full justify-center">
    {
      featured ? (
        <a
          href={getLocalizedUrl(`/gags/${gag.data.slug}`, lang)}
          class="bg-primary text-primary-foreground hover:bg-primary/90 rounded-lg px-12 py-3 text-center text-base font-medium transition-colors sm:px-16"
        >
          {t("자세히 보기", "View Details")}
        </a>
      ) : (
        <button class="random-gag-btn bg-primary text-primary-foreground hover:bg-primary/90 rounded-lg px-12 py-3 text-center text-base font-medium transition-colors sm:px-16">
          {t("다른 개그", "Random Gag")}
        </button>
      )
    }
  </footer>
</article>

<script>
  import { initGagInteractions } from "../scripts/gagInteractions";
  import { initAnswerReveal } from "../scripts/answerReveal";

  // Astro View Transitions 이벤트 사용
  document.addEventListener("astro:page-load", () => {
    // 개그 상호작용 초기화 (북마크, 공유 등)
    initGagInteractions();

    // 정답 공개 기능
    initAnswerReveal(document, {
      typingSpeed: 60,
      showCursor: true,
      completionAnimation: true,
    });
  });
</script>
