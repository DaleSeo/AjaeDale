---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

type GagEntry = CollectionEntry<"gags">;

export async function getStaticPaths() {
  const allGags = await getCollection("gags", ({ data }: GagEntry) => {
    return data.published === true;
  });

  return allGags.map((gag: GagEntry) => ({
    params: {
      slug: gag.data.slug,
    },
    props: { gag },
  }));
}

interface Props {
  gag: GagEntry;
}

const { gag }: Props = Astro.props;

const categoryEmojis: Record<string, string> = {
  joke: "ğŸ˜‚",
  pun: "ğŸ¤“",
};

const categoryNames: Record<string, string> = {
  joke: "ë†ë‹´",
  pun: "ë§ì¥ë‚œ",
};

// SEOë¥¼ ìœ„í•œ ë©”íƒ€ ë°ì´í„°
const siteTitle = `${gag.data.title} - ì•„ì¬ë‹¬ë ˆ`;
const pageDescription = gag.data.body
  ? `${gag.data.title} ${gag.data.body}`
  : gag.data.title;
---

<BaseLayout
  title={gag.data.title}
  description={pageDescription}
  ogTitle={siteTitle}
  ogDescription={pageDescription}
  currentPage="gag"
>
  <div class="breadcrumb">
    <a href="/">í™ˆ</a> > <span>ê°œê·¸</span>
  </div>

  <!-- ê°œë³„ ê°œê·¸ ì¹´ë“œ -->
  <article class="gag-detail" data-pagefind-body>
    <h1 data-pagefind-meta="title" style="display: none;">
      {gag.data.title}
    </h1>
    <div class="gag-header">
      <span class="category">
        {categoryEmojis[gag.data.category]}
        {categoryNames[gag.data.category]}
      </span>
      {gag.data.featured && <span class="featured">â­ ì¸ê¸°</span>}
    </div>

    <h1 class="gag-title">{gag.data.title}</h1>

    {
      gag.data.category === "pun" ? (
        <div class="pun-format">
          <p class="question">Q: {gag.data.title}</p>
          <p class="answer">A: {gag.data.body}</p>
        </div>
      ) : (
        gag.data.body && <p class="gag-body">{gag.data.body}</p>
      )
    }

    <div class="gag-footer">
      <div class="tags">
        {gag.data.tags.map((tag: string) => <span class="tag">#{tag}</span>)}
      </div>
      <time datetime={gag.data.createdAt.toISOString()}>
        {new Date(gag.data.createdAt).toLocaleDateString("ko-KR")}
      </time>
    </div>

    <!-- ê³µìœ  ë²„íŠ¼ë“¤ -->
    <div class="share-section">
      <h3>ì´ ê°œê·¸ ê³µìœ í•˜ê¸°</h3>
      <div class="share-buttons">
        <button onclick="copyToClipboard()" class="share-btn copy-btn">
          ğŸ“‹ ë§í¬ ë³µì‚¬
        </button>
        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(pageDescription)}&url=${encodeURIComponent(`https://www.ajaedale.com/gags/${gag.data.slug}`)}`}
          target="_blank"
          class="share-btn twitter-btn"
        >
          ğŸ¦ íŠ¸ìœ„í„°
        </a>
      </div>
    </div>

    <!-- ë‹¤ë¥¸ ê°œê·¸ ë³´ê¸° -->
    <div class="navigation-section">
      <a href="/" class="back-link">â† ëª¨ë“  ê°œê·¸ ë³´ê¸°</a>
    </div>
  </article>

  <div slot="scripts">
    <!-- ë§í¬ ë³µì‚¬ ìŠ¤í¬ë¦½íŠ¸ -->
    <script is:inline>
      async function copyToClipboard() {
        const url = window.location.href;
        const btn = document.querySelector(".copy-btn");
        const originalText = btn.textContent;

        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = "âœ… ë³µì‚¬ë¨!";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
          btn.textContent = "âŒ ë³µì‚¬ ì‹¤íŒ¨";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }
      }
    </script>
  </div>
</BaseLayout>

<style>
  main {
    max-width: 800px;
  }

  .breadcrumb {
    margin-bottom: 2rem;
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .breadcrumb a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .gag-detail {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: var(--shadow-md);
  }

  .gag-detail .gag-header {
    margin-bottom: 1rem;
  }

  .gag-detail .category {
    font-size: 1rem;
  }

  .featured {
    font-size: 1rem;
    color: #f59e0b;
    font-weight: 600;
  }

  .gag-title {
    color: var(--color-primary-dark);
    font-size: 2rem;
    margin-bottom: 1.5rem;
    line-height: 1.3;
  }

  .gag-detail .gag-body {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .gag-detail .pun-format {
    margin: 2rem 0;
  }

  .gag-detail .pun-format .question {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .gag-detail .pun-format .answer {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 12px;
  }

  .gag-detail .gag-footer {
    margin-bottom: 2rem;
  }

  .gag-detail .tags {
    gap: 0.75rem;
  }

  .gag-detail .tag {
    padding: 0.5rem 1rem;
    font-weight: 500;
  }

  time {
    font-size: 1rem;
    color: var(--color-text-muted);
  }

  .share-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid var(--color-border);
  }

  .share-section h3 {
    margin-bottom: 1rem;
    color: var(--color-text);
    font-size: 1.25rem;
  }

  .share-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .share-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .copy-btn {
    background: var(--color-primary);
    color: white;
  }

  .copy-btn:hover {
    background: var(--color-primary-dark);
  }

  .twitter-btn {
    background: #1da1f2;
    color: white;
  }

  .twitter-btn:hover {
    background: #1a91da;
  }

  .navigation-section {
    margin-top: 2rem;
  }

  .back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    font-size: 1.125rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 1rem;
    }

    .gag-detail {
      padding: 1.5rem;
    }

    .gag-title {
      font-size: 1.75rem;
    }

    .pun-format .answer {
      font-size: 1.5rem;
      padding: 1rem;
    }

    .gag-footer {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .share-buttons {
      flex-direction: column;
    }

    .share-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
