---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { tagToSlug } from "../../utils/tagUtils";

type GagEntry = CollectionEntry<"gags">;

export async function getStaticPaths() {
  const allGags = await getCollection("gags", ({ data }: GagEntry) => {
    return data.published === true;
  });

  return allGags.map((gag: GagEntry) => ({
    params: {
      slug: gag.data.slug,
    },
    props: { gag },
  }));
}

interface Props {
  gag: GagEntry;
}

const { gag }: Props = Astro.props;

// SEOÎ•º ÏúÑÌïú Î©îÌÉÄ Îç∞Ïù¥ÌÑ∞
const siteTitle = `${gag.data.title} - ÏïÑÏû¨Îã¨Î†à`;
const pageDescription = gag.data.body
  ? `${gag.data.title} ${gag.data.body}`
  : gag.data.title;
---

<BaseLayout
  title={gag.data.title}
  description={pageDescription}
  ogTitle={siteTitle}
  ogDescription={pageDescription}
  currentPage="gag"
>
  <div class="breadcrumb">
    <a href="/">Ìôà</a> > <span>Í∞úÍ∑∏</span>
  </div>

  <!-- Í∞úÎ≥Ñ Í∞úÍ∑∏ Ïπ¥Îìú -->
  <article class="gag-detail" data-pagefind-body>
    <h1 data-pagefind-meta="title" style="display: none;">
      {gag.data.title}
    </h1>
    <div class="gag-header">
      {gag.data.featured && <span class="featured">‚≠ê Ïù∏Í∏∞</span>}
    </div>

    <h1 class="gag-title">{gag.data.title}</h1>

    {
      gag.data.body && (
        <div class="pun-format">
          <p class="answer">A: {gag.data.body}</p>
        </div>
      )
    }

    <div class="gag-footer">
      <div class="tags">
        {
          gag.data.tags.map((tag: string) => (
            <a href={`/tags/${tagToSlug(tag)}`} class="tag">
              #{tag}
            </a>
          ))
        }
      </div>
      <time datetime={gag.data.createdAt.toISOString()}>
        {new Date(gag.data.createdAt).toLocaleDateString("ko-KR")}
      </time>
    </div>

    <!-- Í≥µÏú† Î≤ÑÌäºÎì§ -->
    <div class="share-section">
      <h3>Ïù¥ Í∞úÍ∑∏ Í≥µÏú†ÌïòÍ∏∞</h3>
      <div class="share-buttons">
        <button onclick="copyToClipboard()" class="share-btn copy-btn">
          üìã ÎßÅÌÅ¨ Î≥µÏÇ¨
        </button>
        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(pageDescription)}&url=${encodeURIComponent(`https://www.ajaedale.com/gags/${gag.data.slug}`)}`}
          target="_blank"
          class="share-btn twitter-btn"
        >
          üê¶ Ìä∏ÏúÑÌÑ∞
        </a>
      </div>
    </div>

    <!-- Îã§Î•∏ Í∞úÍ∑∏ Î≥¥Í∏∞ -->
    <div class="navigation-section">
      <a href="/" class="back-link">‚Üê Î™®Îì† Í∞úÍ∑∏ Î≥¥Í∏∞</a>
    </div>
  </article>

  <div slot="scripts">
    <!-- ÎßÅÌÅ¨ Î≥µÏÇ¨ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script is:inline>
      async function copyToClipboard() {
        const url = window.location.href;
        const btn = document.querySelector(".copy-btn");
        const originalText = btn.textContent;

        try {
          await navigator.clipboard.writeText(url);
          btn.textContent = "‚úÖ Î≥µÏÇ¨Îê®!";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error("Failed to copy:", err);
          btn.textContent = "‚ùå Î≥µÏÇ¨ Ïã§Ìå®";
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }
      }
    </script>
  </div>
</BaseLayout>

<style>
  main {
    max-width: 800px;
  }

  .breadcrumb {
    margin-bottom: 2rem;
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }

  .breadcrumb a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .gag-detail {
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: var(--shadow-md);
  }

  .gag-detail .gag-header {
    margin-bottom: 1rem;
  }

  .featured {
    font-size: 1rem;
    color: #f59e0b;
    font-weight: 600;
  }

  .gag-title {
    color: var(--color-primary-dark);
    font-size: 2rem;
    margin-bottom: 1.5rem;
    line-height: 1.3;
  }

  .gag-detail .gag-body {
    font-size: 1.25rem;
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .gag-detail .pun-format {
    margin: 2rem 0;
  }

  .gag-detail .pun-format .question {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .gag-detail .pun-format .answer {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    border-radius: 12px;
  }

  .gag-detail .gag-footer {
    margin-bottom: 2rem;
  }

  .gag-detail .tags {
    gap: 0.75rem;
  }

  .gag-detail .tag {
    padding: 0.5rem 1rem;
    font-weight: 500;
  }

  time {
    font-size: 1rem;
    color: var(--color-text-muted);
  }

  .share-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid var(--color-border);
  }

  .share-section h3 {
    margin-bottom: 1rem;
    color: var(--color-text);
    font-size: 1.25rem;
  }

  .share-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .share-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .copy-btn {
    background: var(--color-primary);
    color: white;
  }

  .copy-btn:hover {
    background: var(--color-primary-dark);
  }

  .twitter-btn {
    background: #1da1f2;
    color: white;
  }

  .twitter-btn:hover {
    background: #1a91da;
  }

  .navigation-section {
    margin-top: 2rem;
  }

  .back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;
    font-size: 1.125rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      gap: 1rem;
    }

    .gag-detail {
      padding: 1.5rem;
    }

    .gag-title {
      font-size: 1.75rem;
    }

    .pun-format .answer {
      font-size: 1.5rem;
      padding: 1rem;
    }

    .gag-footer {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .share-buttons {
      flex-direction: column;
    }

    .share-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
