---
import Layout from "../layouts/Layout.astro";
---

<Layout title="ê²€ìƒ‰" currentPage="search">
  <div class="search-container">
    <div class="search-header">
      <h1>ğŸ” ê°œê·¸ ê²€ìƒ‰</h1>
      <p>ì°¾ê³  ì‹¶ì€ ê°œê·¸ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
    </div>

    <div class="search-input-wrapper">
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="ê°œê·¸ ê²€ìƒ‰..."
        autofocus
      />
    </div>

    <div id="search-results" class="search-results"></div>
    <div id="no-results" class="no-results" style="display: none;">
      ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
    </div>
  </div>
</Layout>

<script>
  // URLì—ì„œ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get("q") || "";

  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const searchResults = document.getElementById("search-results");
  const noResults = document.getElementById("no-results");

  let pagefind: any;

  // Pagefind ì´ˆê¸°í™”
  async function initPagefind() {
    try {
      // @ts-ignore - ë™ì  importë¥¼ ì‚¬ìš©í•˜ì—¬ Vite ë¶„ì„ ìš°íšŒ
      const pagefindPath = "/pagefind/pagefind.js";
      pagefind = await import(/* @vite-ignore */ pagefindPath);
    } catch (e) {
      console.error("Pagefind not available. Run 'bun run build' first.");
    }
  }

  // ê²€ìƒ‰ ìˆ˜í–‰
  async function performSearch(query: string) {
    if (!query.trim()) {
      if (searchResults) searchResults.innerHTML = "";
      if (noResults) noResults.style.display = "none";
      return;
    }

    // URL ì—…ë°ì´íŠ¸
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("q", query);
    window.history.replaceState({}, "", newUrl);

    if (!pagefind) {
      await initPagefind();
    }

    const search = await pagefind.search(query);

    if (!searchResults || !noResults) return;

    if (search.results.length === 0) {
      searchResults.innerHTML = "";
      noResults.style.display = "block";
      return;
    }

    noResults.style.display = "none";

    // ê²°ê³¼ ë Œë”ë§
    const resultsHTML = await Promise.all(
      search.results.map(async (result: any) => {
        const data = await result.data();
        // ë””ë²„ê¹…: ì–´ë–¤ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        console.log("Search result data:", data);

        // contentì—ì„œ ì‹¤ì œ ê°œê·¸ ì œëª© ì¶”ì¶œ (HTML íƒœê·¸ ì œê±°)
        const title = data.content || data.meta.title || "ì œëª© ì—†ìŒ";
        const cleanTitle = title.replace(/<[^>]*>/g, "").trim();

        return `
          <a href="${data.url}" class="search-result-item">
            <h3>${cleanTitle}</h3>
          </a>
        `;
      }),
    );

    searchResults.innerHTML = resultsHTML.join("");
  }

  // Debounce í•¨ìˆ˜
  function debounce(func: Function, wait: number) {
    let timeout: ReturnType<typeof setTimeout>;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  if (searchInput) {
    // ì´ˆê¸° ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ìˆ˜í–‰
    if (initialQuery) {
      searchInput.value = initialQuery;
      performSearch(initialQuery);
    }

    const debouncedSearch = debounce((e: Event) => {
      const target = e.target as HTMLInputElement;
      performSearch(target.value);
    }, 300);

    searchInput.addEventListener("input", debouncedSearch);
  }

  // Pagefind ì´ˆê¸°í™”
  initPagefind();
</script>

<style>
  .search-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .search-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .search-header h1 {
    color: var(--color-primary);
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-2);
  }

  .search-header p {
    color: var(--color-text-muted);
    font-size: var(--font-size-lg);
  }

  .search-input-wrapper {
    margin-bottom: 2rem;
  }

  .search-input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: var(--font-size-lg);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-2xl);
    background: var(--color-card);
    color: var(--color-text);
    transition: var(--transition-base);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-alpha-20);
  }

  .search-results {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .search-result-item {
    display: block;
    padding: 1.5rem;
    background: var(--color-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-2xl);
    text-decoration: none;
    transition: var(--transition-smooth);
    box-shadow: var(--shadow-sm);
  }

  .search-result-item:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .search-result-item h3 {
    color: var(--color-text);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    margin: 0;
  }

  .no-results {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-text-muted);
    font-size: var(--font-size-lg);
  }

  @media (max-width: 768px) {
    .search-container {
      padding: 1rem 0.5rem;
    }

    .search-header h1 {
      font-size: var(--font-size-3xl);
    }

    .search-input {
      font-size: var(--font-size-base);
      padding: 0.875rem 1.25rem;
    }

    .search-result-item {
      padding: 1.25rem;
    }

    .search-result-item h3 {
      font-size: var(--font-size-lg);
    }
  }
</style>
