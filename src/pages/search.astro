---
import BaseLayout from "../layouts/BaseLayout.astro";
import PagefindSearch from "astro-pagefind/components/Search";

// URL에서 검색어 가져오기
const searchParams = Astro.url.searchParams;
const query = searchParams.get("q") || "";
---

<BaseLayout
  title="검색"
  description="아재달레에서 원하는 개그를 검색해보세요"
  currentPage="search"
>
  <section class="search-page">
    <div class="search-header">
      <h2>🔍 개그 검색</h2>
      <p>찾고 싶은 개그를 검색해보세요!</p>
    </div>

    <PagefindSearch
      id="search"
      className="pagefind-ui"
      query={query}
      uiOptions={{
        showImages: false,
        excerptLength: 0,
        translations: {
          clear_search: "✖️",
        },
      }}
    />
  </section>
</BaseLayout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // 검색 입력창이 로드될 때까지 기다림
    const checkForSearch = () => {
      const searchInput = document.querySelector(
        ".pagefind-ui__search-input",
      ) as HTMLInputElement;

      if (searchInput) {
        // URL에서 검색어 복원
        const urlParams = new URLSearchParams(window.location.search);
        const savedQuery = urlParams.get("q");
        if (savedQuery) {
          searchInput.value = savedQuery;
          searchInput.dispatchEvent(new Event("input"));
        }

        // 검색어 변경시 URL 업데이트
        searchInput.addEventListener("input", (e) => {
          const query = (e.target as HTMLInputElement).value;
          const url = new URL(window.location.href);
          if (query) {
            url.searchParams.set("q", query);
          } else {
            url.searchParams.delete("q");
          }
          window.history.replaceState({}, "", url.toString());
        });
      } else {
        // 아직 로드 안됐으면 잠시 후 다시 시도
        setTimeout(checkForSearch, 100);
      }
    };

    checkForSearch();
  });
</script>

<style>
  .search-page {
    max-width: 800px;
    margin: 0 auto;
  }

  .search-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .search-header h2 {
    color: var(--color-primary);
    font-size: 2.5rem;
    margin-bottom: 1rem;
  }

  .search-header p {
    color: var(--color-text-muted);
    font-size: 1.25rem;
  }

  #search {
    min-height: 400px;
  }

  /* 검색 결과에서 본문 숨김 (질문만 표시) */
  :global(.pagefind-ui__result-excerpt) {
    display: none !important;
  }

  /* 검색 결과 내부 마진 제거 */
  :global(.pagefind-ui__result-inner) {
    margin-top: 0 !important;
  }

  /* 검색 결과 스타일링 */
  :global(.pagefind-ui__result) {
    border-radius: 12px !important;
    padding: 1.5rem !important;
    margin-bottom: 0.5rem !important;
    background: var(--color-card) !important;
    border: 1px solid var(--color-border) !important;
  }

  :global(.pagefind-ui__result:hover) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  :global(.pagefind-ui__result-title) {
    color: var(--color-primary) !important;
    font-size: 1.25rem !important;
    font-weight: 600 !important;
  }

  @media (max-width: 768px) {
    .search-header h2 {
      font-size: 2rem;
    }

    .search-header p {
      font-size: 1.125rem;
    }

    :global(.pagefind-ui__result) {
      padding: 1.25rem !important;
    }
  }
</style>
