---
import Layout from "../layouts/Layout.astro";
import SearchIcon from "../icons/Search.astro";
import XIcon from "../icons/X.astro";
---

<Layout title="ê²€ìƒ‰ | ì•„ì¬ë‹¬ë ˆ" currentPage="search">
  <!-- í—¤ë” ì„¹ì…˜ -->
  <section class="py-12 px-4 bg-gradient-to-b from-primary/5 to-background">
    <div class="container mx-auto text-center max-w-4xl">
      <h1 class="text-3xl md:text-4xl font-bold text-foreground mb-3">
        ğŸ” ê°œê·¸ ê²€ìƒ‰
      </h1>
      <p class="text-lg text-muted-foreground">ì°¾ê³  ì‹¶ì€ ê°œê·¸ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”</p>
    </div>
  </section>

  <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
  <section class="py-8 px-4">
    <div class="container mx-auto max-w-4xl">
      <!-- ê²€ìƒ‰ ì…ë ¥ -->
      <div class="mb-8">
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
          >
            <SearchIcon size={20} class="text-muted-foreground" />
          </div>
          <input
            type="text"
            id="search-input"
            class="w-full pl-12 pr-12 py-4 bg-card border-2 border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all text-foreground placeholder-muted-foreground text-lg"
            placeholder="ê°œê·¸ ê²€ìƒ‰..."
            autofocus
          />
          <button
            id="clear-button"
            class="absolute inset-y-0 right-0 pr-4 flex items-center text-muted-foreground hover:text-foreground transition-colors hidden"
            aria-label="ê²€ìƒ‰ì–´ ì§€ìš°ê¸°"
          >
            <XIcon size={20} />
          </button>
        </div>
        <p class="text-sm text-muted-foreground mt-2 ml-1">
          ê°œê·¸ ì œëª©ì´ë‚˜ ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </p>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div id="search-results" class="space-y-4"></div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ -->
      <div
        id="no-results"
        class="hidden text-center py-12 bg-card border border-border rounded-xl"
      >
        <div class="text-4xl mb-4">ğŸ”</div>
        <p class="text-xl text-muted-foreground mb-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>
        <p class="text-sm text-muted-foreground">
          ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
        </p>
      </div>
    </div>
  </section>
</Layout>

<script>
  // URLì—ì„œ ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get("q") || "";

  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const searchResults = document.getElementById("search-results");
  const noResults = document.getElementById("no-results");
  const clearButton = document.getElementById("clear-button");

  let pagefind: any;

  // Pagefind ì´ˆê¸°í™”
  async function initPagefind() {
    try {
      // @ts-ignore - ë™ì  importë¥¼ ì‚¬ìš©í•˜ì—¬ Vite ë¶„ì„ ìš°íšŒ
      const pagefindPath = "/pagefind/pagefind.js";
      pagefind = await import(/* @vite-ignore */ pagefindPath);
    } catch (e) {
      console.error("Pagefind not available. Run 'bun run build' first.");
    }
  }

  // Clear ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
  function updateClearButton() {
    if (!clearButton) return;
    if (searchInput.value.trim()) {
      clearButton.classList.remove("hidden");
    } else {
      clearButton.classList.add("hidden");
    }
  }

  // ê²€ìƒ‰ ìˆ˜í–‰
  async function performSearch(query: string) {
    updateClearButton();

    if (!query.trim()) {
      if (searchResults) searchResults.innerHTML = "";
      if (noResults) noResults.classList.add("hidden");
      return;
    }

    // URL ì—…ë°ì´íŠ¸
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("q", query);
    window.history.replaceState({}, "", newUrl);

    if (!pagefind) {
      await initPagefind();
    }

    const search = await pagefind.search(query);

    if (!searchResults || !noResults) return;

    if (search.results.length === 0) {
      searchResults.innerHTML = "";
      noResults.classList.remove("hidden");
      return;
    }

    noResults.classList.add("hidden");

    // ê²°ê³¼ ë Œë”ë§
    const resultsHTML = await Promise.all(
      search.results.map(async (result: any) => {
        const data = await result.data();

        // contentì—ì„œ ì‹¤ì œ ê°œê·¸ ì œëª© ì¶”ì¶œ (HTML íƒœê·¸ ì œê±°)
        const title = data.content || data.meta.title || "ì œëª© ì—†ìŒ";
        const cleanTitle = title.replace(/<[^>]*>/g, "").trim();

        // excerpt ì¶”ì¶œ (ìˆëŠ” ê²½ìš°)
        const excerpt = data.excerpt || "";
        const cleanExcerpt = excerpt.replace(/<[^>]*>/g, "").trim();

        return `
          <a href="${data.url}" class="block p-6 bg-card border border-border rounded-lg hover:border-primary/50 hover:shadow-md transition-all duration-200 group">
            <h3 class="text-lg font-semibold text-foreground mb-2 group-hover:text-primary transition-colors">
              ${cleanTitle}
            </h3>
            ${cleanExcerpt ? `<p class="text-sm text-muted-foreground line-clamp-2">${cleanExcerpt}</p>` : ""}
          </a>
        `;
      }),
    );

    searchResults.innerHTML = resultsHTML.join("");
  }

  // Debounce í•¨ìˆ˜
  function debounce(func: Function, wait: number) {
    let timeout: ReturnType<typeof setTimeout>;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  if (searchInput) {
    // ì´ˆê¸° ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ìˆ˜í–‰
    if (initialQuery) {
      searchInput.value = initialQuery;
      performSearch(initialQuery);
    }

    const debouncedSearch = debounce((e: Event) => {
      const target = e.target as HTMLInputElement;
      performSearch(target.value);
    }, 300);

    searchInput.addEventListener("input", debouncedSearch);
  }

  // Clear ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
  if (clearButton) {
    clearButton.addEventListener("click", () => {
      searchInput.value = "";
      searchInput.focus();
      performSearch("");
    });
  }

  // Pagefind ì´ˆê¸°í™”
  initPagefind();
</script>
