---
import Layout from "../layouts/Layout.astro";
import SearchIcon from "../icons/Search.astro";
import XIcon from "../icons/X.astro";
---

<Layout title="검색 | 아재달레" currentPage="search">
  <!-- 헤더 섹션 -->
  <section class="py-12 px-4 bg-gradient-to-b from-primary/5 to-background">
    <div class="container mx-auto text-center max-w-4xl">
      <h1 class="text-3xl md:text-4xl font-bold text-foreground mb-3">
        🔍 개그 검색
      </h1>
      <p class="text-lg text-muted-foreground">찾고 싶은 개그를 검색해보세요</p>
    </div>
  </section>

  <!-- 검색 섹션 -->
  <section class="py-8 px-4">
    <div class="container mx-auto max-w-4xl">
      <!-- 검색 입력 -->
      <div class="mb-8">
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
          >
            <SearchIcon size={20} class="text-muted-foreground" />
          </div>
          <input
            type="text"
            id="search-input"
            class="w-full pl-12 pr-12 py-4 bg-card border-2 border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all text-foreground placeholder-muted-foreground text-lg"
            placeholder="개그 검색..."
            autofocus
          />
          <button
            id="clear-button"
            class="absolute inset-y-0 right-0 pr-4 flex items-center text-muted-foreground hover:text-foreground transition-colors hidden"
            aria-label="검색어 지우기"
          >
            <XIcon size={20} />
          </button>
        </div>
        <p class="text-sm text-muted-foreground mt-2 ml-1">
          개그 제목이나 내용으로 검색할 수 있습니다
        </p>
      </div>

      <!-- 검색 결과 -->
      <div id="search-results" class="space-y-4"></div>

      <!-- 검색 결과 없음 -->
      <div
        id="no-results"
        class="hidden text-center py-12 bg-card border border-border rounded-xl"
      >
        <div class="text-4xl mb-4">🔍</div>
        <p class="text-xl text-muted-foreground mb-2">검색 결과가 없습니다</p>
        <p class="text-sm text-muted-foreground">
          다른 키워드로 다시 검색해보세요
        </p>
      </div>
    </div>
  </section>
</Layout>

<script>
  // URL에서 검색어 가져오기
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get("q") || "";

  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const searchResults = document.getElementById("search-results");
  const noResults = document.getElementById("no-results");
  const clearButton = document.getElementById("clear-button");

  let pagefind: any;

  // Pagefind 초기화
  async function initPagefind() {
    try {
      // @ts-ignore - 동적 import를 사용하여 Vite 분석 우회
      const pagefindPath = "/pagefind/pagefind.js";
      pagefind = await import(/* @vite-ignore */ pagefindPath);
    } catch (e) {
      console.error("Pagefind not available. Run 'bun run build' first.");
    }
  }

  // Clear 버튼 표시/숨김 업데이트
  function updateClearButton() {
    if (!clearButton) return;
    if (searchInput.value.trim()) {
      clearButton.classList.remove("hidden");
    } else {
      clearButton.classList.add("hidden");
    }
  }

  // 검색 수행
  async function performSearch(query: string) {
    updateClearButton();

    if (!query.trim()) {
      if (searchResults) searchResults.innerHTML = "";
      if (noResults) noResults.classList.add("hidden");
      return;
    }

    // URL 업데이트
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set("q", query);
    window.history.replaceState({}, "", newUrl);

    if (!pagefind) {
      await initPagefind();
    }

    const search = await pagefind.search(query);

    if (!searchResults || !noResults) return;

    if (search.results.length === 0) {
      searchResults.innerHTML = "";
      noResults.classList.remove("hidden");
      return;
    }

    noResults.classList.add("hidden");

    // 결과 렌더링
    const resultsHTML = await Promise.all(
      search.results.map(async (result: any) => {
        const data = await result.data();

        // content에서 실제 개그 제목 추출 (HTML 태그 제거)
        const title = data.content || data.meta.title || "제목 없음";
        const cleanTitle = title.replace(/<[^>]*>/g, "").trim();

        // excerpt 추출 (있는 경우)
        const excerpt = data.excerpt || "";
        const cleanExcerpt = excerpt.replace(/<[^>]*>/g, "").trim();

        return `
          <a href="${data.url}" class="block p-6 bg-card border border-border rounded-lg hover:border-primary/50 hover:shadow-md transition-all duration-200 group">
            <h3 class="text-lg font-semibold text-foreground mb-2 group-hover:text-primary transition-colors">
              ${cleanTitle}
            </h3>
            ${cleanExcerpt ? `<p class="text-sm text-muted-foreground line-clamp-2">${cleanExcerpt}</p>` : ""}
          </a>
        `;
      }),
    );

    searchResults.innerHTML = resultsHTML.join("");
  }

  // Debounce 함수
  function debounce(func: Function, wait: number) {
    let timeout: ReturnType<typeof setTimeout>;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 이벤트 리스너
  if (searchInput) {
    // 초기 검색어가 있으면 검색 수행
    if (initialQuery) {
      searchInput.value = initialQuery;
      performSearch(initialQuery);
    }

    const debouncedSearch = debounce((e: Event) => {
      const target = e.target as HTMLInputElement;
      performSearch(target.value);
    }, 300);

    searchInput.addEventListener("input", debouncedSearch);
  }

  // Clear 버튼 클릭 이벤트
  if (clearButton) {
    clearButton.addEventListener("click", () => {
      searchInput.value = "";
      searchInput.focus();
      performSearch("");
    });
  }

  // Pagefind 초기화
  initPagefind();
</script>
