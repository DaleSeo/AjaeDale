---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import GagCard from "../components/GagCard.astro";
import BookmarkIcon from "../icons/Bookmark.astro";
import Share2Icon from "../icons/Share2.astro";
import { enrichGagsWithLikes } from "../utils/discussionsApi";
import { sortGagsByPopularity } from "../utils/popularityUtils";

type GagEntry = CollectionEntry<"gags">;

const allGags = await getCollection("gags", ({ data }: GagEntry) => {
  return data.published === true;
});

// ì˜¤ëŠ˜ì˜ ê°œê·¸ ì„ íƒ (ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ëœ ì„ íƒ)
function getTodaysGag(gags: GagEntry[]): GagEntry {
  const today = new Date();
  const dayOfYear = Math.floor(
    (today.getTime() - new Date(today.getFullYear(), 0, 0).getTime()) /
      (1000 * 60 * 60 * 24),
  );
  const index = dayOfYear % gags.length;
  return gags[index];
}

const todaysGag = getTodaysGag(allGags);

// ì¸ê¸° ê°œê·¸ ê°€ì ¸ì˜¤ê¸°
const gagsWithLikesData = await enrichGagsWithLikes(allGags);
const popularGags = sortGagsByPopularity(gagsWithLikesData);
const topPopularGags = popularGags.slice(0, 6);

const totalGagsCount = allGags.length;
---

<Layout title="í™ˆ" currentPage="home">
  <Hero />

  <!-- ì˜¤ëŠ˜ì˜ ê°œê·¸ ì„¹ì…˜ -->
  <section class="py-16 px-4 bg-gradient-to-b from-primary/5 to-background">
    <div class="container mx-auto max-w-4xl">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-foreground mb-2">âœ¨ ì˜¤ëŠ˜ì˜ ê°œê·¸</h2>
        <p class="text-muted-foreground">
          ë§¤ì¼ ë°”ë€ŒëŠ” íŠ¹ë³„í•œ ê°œê·¸ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”
        </p>
      </div>

      <div
        class="bg-gradient-to-br from-primary/10 via-background to-primary/5 border-2 border-primary/20 rounded-2xl p-8 md:p-12 shadow-lg hover:shadow-xl transition-all duration-300"
      >
        <div class="flex items-start justify-between mb-6">
          <div class="flex items-center gap-3">
            {
              todaysGag.data.tags.length > 0 && (
                <span class="inline-block px-4 py-2 bg-primary text-primary-foreground text-sm font-bold rounded-full shadow-md">
                  #{todaysGag.data.tags[0]}
                </span>
              )
            }
            <span
              class="inline-block px-3 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full animate-pulse"
            >
              TODAY
            </span>
          </div>
          <div class="flex items-center space-x-2">
            <button
              class="save-btn p-3 hover:bg-background/50 rounded-lg transition-colors"
              data-gag={JSON.stringify({
                slug: todaysGag.data.slug,
                title: todaysGag.data.title,
                body: todaysGag.data.body,
              })}
              aria-label="ì €ì¥"
            >
              <BookmarkIcon class="bookmark-icon w-6 h-6" />
              <BookmarkIcon
                class="bookmark-check-icon w-6 h-6 hidden text-primary"
                fill="currentColor"
              />
            </button>
            <button
              class="share-btn p-3 hover:bg-background/50 rounded-lg transition-colors"
              data-content={`${todaysGag.data.title}${todaysGag.data.body ? " - " + todaysGag.data.body : ""}`}
              data-slug={todaysGag.data.slug}
              aria-label="ê³µìœ "
            >
              <Share2Icon size={24} />
            </button>
          </div>
        </div>

        <div class="mb-6 text-center">
          <h3 class="text-xl md:text-2xl font-bold text-foreground mb-3">
            Q. {todaysGag.data.title}
          </h3>
          {
            todaysGag.data.body && (
              <p class="text-lg md:text-xl text-foreground">
                A. {todaysGag.data.body}
              </p>
            )
          }
        </div>

        <div class="mt-6 text-center">
          <a
            href={`/gags/${todaysGag.data.slug}`}
            class="inline-flex items-center px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium"
          >
            ìì„¸íˆ ë³´ê¸°
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="ml-2"
            >
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- ì¸ê¸° ê°œê·¸ ì„¹ì…˜ -->
  <section class="py-16 px-4">
    <div class="container mx-auto max-w-6xl">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-bold text-foreground mb-2">
          ğŸ”¥ ì¸ê¸° ì•„ì¬ê°œê·¸
        </h2>
        <p class="text-muted-foreground">
          ê°€ì¥ ë§ì€ ì‚¬ë‘ì„ ë°›ê³  ìˆëŠ” ê°œê·¸ë“¤ì´ì—ìš”
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {
          topPopularGags.map((gag) => (
            <GagCard gag={gag} spoilerId={`home-popular-${gag.data.slug}`} />
          ))
        }
      </div>

      <div class="text-center">
        <a
          href="/popular"
          class="inline-flex items-center px-6 py-3 border border-border rounded-lg hover:bg-accent transition-colors"
        >
          ì¸ê¸° ê°œê·¸ ë”ë³´ê¸°
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="ml-2"
          >
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- í†µê³„ ì„¹ì…˜ -->
  <section class="py-16 px-4 bg-gradient-to-b from-background to-primary/5">
    <div class="container mx-auto text-center">
      <p class="text-xl text-muted-foreground mb-8">
        ì´ <strong class="text-primary text-2xl">{totalGagsCount}ê°œ</strong>ì˜
        ì¬ë¯¸ìˆëŠ” ê°œê·¸ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!
      </p>

      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
        <a
          href="/random"
          class="text-lg font-medium px-8 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors shadow-md hover:shadow-lg"
        >
          ğŸ² ëœë¤ ê°œê·¸ ë³´ê¸°
        </a>
        <a
          href="/search"
          class="text-lg font-medium px-8 py-3 border border-border rounded-lg hover:bg-accent transition-colors shadow-sm hover:shadow-md"
        >
          ğŸ” ê°œê·¸ ê²€ìƒ‰í•˜ê¸°
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  // localStorage í‚¤
  const STORAGE_KEY = "ajae-gag-saved";

  // ì €ì¥ëœ ê°œê·¸ ê°€ì ¸ì˜¤ê¸°
  function getSavedGags(): any[] {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved ? JSON.parse(saved) : [];
  }

  // ê°œê·¸ ì €ì¥/ì œê±°
  function toggleSaveGag(gag: any): boolean {
    const saved = getSavedGags();
    const index = saved.findIndex((item: any) => item.slug === gag.slug);

    if (index > -1) {
      saved.splice(index, 1);
    } else {
      saved.push(gag);
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
    return index === -1;
  }

  // ê°œê·¸ê°€ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
  function isGagSaved(gagSlug: string): boolean {
    const saved = getSavedGags();
    return saved.some((gag: any) => gag.slug === gagSlug);
  }

  // UI ì—…ë°ì´íŠ¸
  function updateSaveButtons(): void {
    document.querySelectorAll(".save-btn").forEach((btn: Element) => {
      const htmlBtn = btn as HTMLElement;
      const gag = JSON.parse(htmlBtn.dataset.gag || "{}");
      const bookmarkIcon = btn.querySelector(".bookmark-icon");
      const bookmarkCheckIcon = btn.querySelector(".bookmark-check-icon");

      if (isGagSaved(gag.slug)) {
        bookmarkIcon?.classList.add("hidden");
        bookmarkCheckIcon?.classList.remove("hidden");
      } else {
        bookmarkIcon?.classList.remove("hidden");
        bookmarkCheckIcon?.classList.add("hidden");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    updateSaveButtons();

    // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll(".save-btn").forEach((btn: Element) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const htmlBtn = btn as HTMLElement;
        const gag = JSON.parse(htmlBtn.dataset.gag || "{}");
        toggleSaveGag(gag);
        updateSaveButtons();
      });
    });

    // ê³µìœ  ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll(".share-btn").forEach((btn: Element) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const htmlBtn = btn as HTMLElement;
        const content = htmlBtn.dataset.content || "";
        const slug = htmlBtn.dataset.slug || "";
        const url = `${window.location.origin}/gags/${slug}`;

        if (navigator.share) {
          navigator.share({
            title: "ì˜¤ëŠ˜ì˜ ì•„ì¬ê°œê·¸",
            text: content,
            url: url,
          });
        } else {
          navigator.clipboard.writeText(`${content}\n${url}`).then(() => {
            const originalHtml = htmlBtn.innerHTML;
            htmlBtn.innerHTML = "âœ“";
            setTimeout(() => {
              htmlBtn.innerHTML = originalHtml;
            }, 1000);
          });
        }
      });
    });

    // storage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener("storage", (e: StorageEvent) => {
      if (e.key === STORAGE_KEY) {
        updateSaveButtons();
      }
    });
  });
</script>
