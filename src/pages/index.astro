---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import AnswerSpoiler from "../components/AnswerSpoiler.astro";
import { tagToSlug } from "../utils/tagUtils";

type GagEntry = CollectionEntry<"gags">;

const allGags = await getCollection("gags", ({ data }: GagEntry) => {
  return data.published === true;
});

// 오늘의 개그 선택 (날짜 기반으로 일관된 선택)
function getTodaysGag(gags: GagEntry[]): GagEntry {
  const today = new Date();
  const dayOfYear = Math.floor(
    (today.getTime() - new Date(today.getFullYear(), 0, 0).getTime()) /
      (1000 * 60 * 60 * 24),
  );
  const index = dayOfYear % gags.length;
  return gags[index];
}

const todaysGag = getTodaysGag(allGags);
const totalGagsCount = allGags.length;
---

<BaseLayout title="홈" currentPage="home">
  <!-- 오늘의 개그 섹션 -->
  <section class="todays-gag">
    <div class="section-header">
      <h2>🌟 오늘의 개그</h2>
      <p>
        {
          new Date().toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }
      </p>
    </div>

    <article class="gag-card featured featured-gag">
      <h3 class="gag-title">{todaysGag.data.title}</h3>

      {
        todaysGag.data.body && (
          <AnswerSpoiler answer={todaysGag.data.body} id="todays-gag" />
        )
      }

      <div class="gag-footer">
        <div class="tags">
          {
            todaysGag.data.tags.map((tag: string) => (
              <a href={`/tags/${tagToSlug(tag)}`} class="tag">
                #{tag}
              </a>
            ))
          }
        </div>
        <a href={`/gags/${todaysGag.data.slug}`} class="detail-link"
          >자세히 보기 →</a
        >
      </div>
    </article>
  </section>

  <!-- 더 많은 개그 보기 -->
  <section class="stats-section">
    <p class="stats-text">
      총 <strong>{totalGagsCount}개</strong>의 개그가 기다리고 있어요!
    </p>

    <div class="action-buttons">
      <a href="/random" class="action-button random"> 🎲 랜덤 개그 보기 </a>
      <a href="/search" class="action-button search"> 🔍 개그 검색하기 </a>
    </div>
  </section>
</BaseLayout>
