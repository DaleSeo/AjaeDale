---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Card from "../../components/Card.astro";
import DailyGag from "../../components/DailyGag.astro";
import { enrichGagsWithLikes } from "../../utils/discussionsApi";
import { sortGagsByPopularity } from "../../utils/popularityUtils";
import {
  getLocalizedUrl,
  getStaticPathsLocales,
  normalizeLang,
  useTranslations,
} from "../../utils/i18n";

export async function getStaticPaths() {
  return getStaticPathsLocales().map((lang) => ({
    params: { lang },
  }));
}

type GagEntry = CollectionEntry<"gags">;

const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);

const allGags = await getCollection("gags", ({ data }: GagEntry) => {
  return data.published === true;
});

// ì˜¤ëŠ˜ì˜ ê°œê·¸ ì„ íƒ (ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ì¼ê´€ëœ ì„ íƒ)
function getTodaysGag(gags: GagEntry[]): GagEntry {
  const today = new Date();
  const dayOfYear = Math.floor(
    (today.getTime() - new Date(today.getFullYear(), 0, 0).getTime()) /
      (1000 * 60 * 60 * 24),
  );
  const index = dayOfYear % gags.length;
  return gags[index];
}

const todaysGag = getTodaysGag(allGags);

// ì¸ê¸° ê°œê·¸ ê°€ì ¸ì˜¤ê¸°
const gagsWithLikesData = await enrichGagsWithLikes(allGags);
const popularGags = sortGagsByPopularity(gagsWithLikesData);
const topPopularGags = popularGags.slice(0, 6);

const totalGagsCount = allGags.length;

const t = useTranslations(lang);
---

<Layout title={t("í™ˆ", "Home")} currentPage="home" lang={lang}>
  <!-- ì˜¤ëŠ˜ì˜ ê°œê·¸ ì„¹ì…˜ -->
  <DailyGag gag={todaysGag} lang={lang} />

  <!-- ì¸ê¸° ê°œê·¸ ì„¹ì…˜ -->
  <section class="px-4 py-16">
    <div class="container mx-auto max-w-6xl">
      <div class="mb-12 text-center">
        <h2 class="text-foreground mb-2 text-3xl font-bold">
          ğŸ”¥ {t("ì¸ê¸° ì•„ì¬ê°œê·¸", "Popular Puns")}
        </h2>
        <p class="text-muted-foreground">
          {
            t(
              "ê°€ì¥ ë§ì€ ì‚¬ë‘ì„ ë°›ê³  ìˆëŠ” ê°œê·¸ë“¤ì´ì—ìš”",
              "The most loved puns by our community",
            )
          }
        </p>
      </div>

      <div class="mb-8 grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
        {topPopularGags.map((gag) => <Card gag={gag} lang={lang} />)}
      </div>

      <div class="text-center">
        <a
          href={getLocalizedUrl("/popular", lang)}
          class="border-border hover:bg-accent inline-flex items-center rounded-lg border px-6 py-3 transition-colors"
        >
          {t("ì¸ê¸° ê°œê·¸ ë”ë³´ê¸°", "View More Popular Puns")}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="ml-2"
          >
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- í†µê³„ ì„¹ì…˜ -->
  <section class="from-background to-primary/5 bg-gradient-to-b px-4 py-16">
    <div class="container mx-auto text-center">
      <p class="text-muted-foreground mb-8 text-xl">
        {
          t(
            `ì´ ${totalGagsCount}ê°œì˜ ì¬ë¯¸ìˆëŠ” ê°œê·¸ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!`,
            `${totalGagsCount} funny puns waiting for you!`,
          )
        }
      </p>
    </div>

    <div class="flex flex-col items-center justify-center gap-4 sm:flex-row">
      <a
        href={getLocalizedUrl("/random", lang)}
        class="bg-primary text-primary-foreground hover:bg-primary/90 rounded-lg px-8 py-3 text-lg font-medium shadow-md transition-colors hover:shadow-lg"
      >
        {t("ğŸ² ëœë¤ ê°œê·¸ ë³´ê¸°", "ğŸ² Random Pun")}
      </a>
      <a
        href={getLocalizedUrl("/search", lang)}
        class="border-border hover:bg-accent rounded-lg border px-8 py-3 text-lg font-medium shadow-sm transition-colors hover:shadow-md"
      >
        {t("ğŸ” ê°œê·¸ ê²€ìƒ‰í•˜ê¸°", "ğŸ” Search Puns")}
      </a>
    </div>
  </section>
</Layout>

<script>
  import { initGagInteractions } from "../../scripts/gagInteractions";

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  initGagInteractions();
</script>
