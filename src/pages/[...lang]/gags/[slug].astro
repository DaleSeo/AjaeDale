---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Heading from "../../../components/Heading.astro";
import Recommendation from "../../../components/Recommendation.astro";
import Giscus from "../../../components/Giscus.astro";
import DetailCard from "../../../components/DetailCard.astro";
import {
  getStaticPathsLocales,
  normalizeLang,
  useTranslations,
} from "../../../utils/i18n";
import { getRecommendedGags } from "../../../utils/recommendGags";

type GagEntry = CollectionEntry<"gags">;

export async function getStaticPaths() {
  const allGags = await getCollection("gags", ({ data }: GagEntry) => {
    return data.published === true;
  });

  const paths = [];
  for (const lang of getStaticPathsLocales()) {
    for (const gag of allGags) {
      const recommendedGags = getRecommendedGags(gag, allGags, 6);
      paths.push({
        params: {
          lang,
          slug: gag.data.slug,
        },
        props: { gag, recommendedGags },
      });
    }
  }
  return paths;
}

interface Props {
  gag: GagEntry;
  recommendedGags: GagEntry[];
}

const { gag, recommendedGags }: Props = Astro.props;
const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);
const t = useTranslations(lang);
---

<Layout title={gag.data.title} currentPage="gag" lang={lang}>
  <!-- í—¤ë” ì„¹ì…˜ -->
  <section class="from-primary/5 to-background bg-gradient-to-b px-4 py-12">
    <div class="container mx-auto max-w-2xl">
      <!-- í˜ì´ì§€ í—¤ë”© -->
      <Heading
        title={`ğŸ˜‚ ${t("ì•„ì¬ ê°œê·¸", "Dad Joke")}`}
        subtitle={t(
          "ìœ ì¹˜í•˜ë‹¤ê³  í•´ë†“ê³  í”¼ì‹í•˜ë©´ ì§€ëŠ” ê±°ë‹¤ ã…‹ã…‹",
          "So lame you can't help but laugh LOL",
        )}
      />

      <DetailCard gag={gag} lang={lang} />
    </div>
  </section>

  <Recommendation gags={recommendedGags} lang={lang} />

  <article class="px-4 py-8">
    <div class="container mx-auto max-w-6xl">
      <Giscus />
    </div>
  </article>
</Layout>

<script>
  import { initGagInteractions } from "../../../scripts/gagInteractions";
  import { initAnswerReveal } from "../../../scripts/answerReveal";

  // ëœë¤ ê°œê·¸ ë³´ê¸° ê¸°ëŠ¥
  function initRandomGag() {
    const randomButton = document.querySelector(".random-gag-btn");
    if (!randomButton) return;

    randomButton.addEventListener("click", async () => {
      try {
        const response = await fetch("/api/gags.json");
        const gags = await response.json();

        if (gags.length === 0) return;

        // í˜„ì¬ URL íŒŒì‹±
        const pathParts = window.location.pathname
          .split("/")
          .filter((part) => part);

        let currentLang = "ko";
        let currentSlug = "";

        if (pathParts.length >= 2 && pathParts[0] === "gags") {
          // í•œêµ­ì–´: /gags/slug
          currentLang = "ko";
          currentSlug = pathParts[1];
        } else if (pathParts.length >= 3 && pathParts[1] === "gags") {
          // ì˜ì–´: /en/gags/slug
          currentLang = pathParts[0];
          currentSlug = pathParts[2];
        }

        // í˜„ì¬ ê°œê·¸ë¥¼ ì œì™¸í•œ ë‹¤ë¥¸ ê°œê·¸ë“¤
        const otherGags = gags.filter((gag: any) => gag.slug !== currentSlug);

        if (otherGags.length === 0) return;

        // ëœë¤ ê°œê·¸ ì„ íƒ
        const randomGag =
          otherGags[Math.floor(Math.random() * otherGags.length)];

        // ëœë¤ ê°œê·¸ í˜ì´ì§€ë¡œ ì´ë™
        // í•œêµ­ì–´: /gags/slug, ì˜ì–´: /en/gags/slug
        if (currentLang === "ko") {
          window.location.href = `/gags/${randomGag.slug}`;
        } else {
          window.location.href = `/${currentLang}/gags/${randomGag.slug}`;
        }
      } catch (error) {
        console.error("Failed to load random gag:", error);
      }
    });
  }

  // í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
  function init() {
    initGagInteractions();
    initAnswerReveal(document, {
      typingSpeed: 60,
      showCursor: true,
      completionAnimation: true,
    });
    initRandomGag();
  }

  // Astro View Transitions ì´ë²¤íŠ¸ ì‚¬ìš©
  document.addEventListener("astro:page-load", init);
</script>
