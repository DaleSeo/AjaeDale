---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Detail from "../../../components/Detail.astro";
import Recommendation from "../../../components/Recommendation.astro";
import Giscus from "../../../components/Giscus.astro";
import { getStaticPathsLocales, normalizeLang } from "../../../utils/i18n";
import { getRecommendedGags } from "../../../utils/recommendGags";

type GagEntry = CollectionEntry<"gags">;

export async function getStaticPaths() {
  const allGags = await getCollection("gags", ({ data }: GagEntry) => {
    return data.published === true;
  });

  const paths = [];
  for (const lang of getStaticPathsLocales()) {
    for (const gag of allGags) {
      const recommendedGags = getRecommendedGags(gag, allGags, 6);
      paths.push({
        params: {
          lang,
          slug: gag.data.slug,
        },
        props: { gag, recommendedGags },
      });
    }
  }
  return paths;
}

interface Props {
  gag: GagEntry;
  recommendedGags: GagEntry[];
}

const { gag, recommendedGags }: Props = Astro.props;
const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);
---

<Layout title={gag.data.title} currentPage="gag" lang={lang}>
  <article class="container mx-auto max-w-4xl px-4 py-8">
    <h1 class="sr-only" data-pagefind-body>{gag.data.title}</h1>

    <Detail gag={gag} lang={lang} />
  </article>

  <Recommendation gags={recommendedGags} lang={lang} />

  <article class="container mx-auto max-w-4xl px-4 py-8">
    <Giscus />
  </article>
</Layout>
