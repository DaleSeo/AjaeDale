---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import ListCard from "../../../components/ListCard.astro";
import { tagToSlug } from "../../../utils/tagUtils";
import {
  getStaticPathsLocales,
  normalizeLang,
  useTranslations,
} from "../../../utils/i18n";

type GagEntry = CollectionEntry<"gags">;

export async function getStaticPaths() {
  const allGags = await getCollection("gags", ({ data }: GagEntry) => {
    return data.published === true;
  });

  const paths = [];

  for (const lang of getStaticPathsLocales()) {
    const allTags = new Set<string>();
    allGags.forEach((gag: GagEntry) => {
      gag.data.tags.forEach((tag: string) => {
        allTags.add(tag);
      });
    });

    for (const tag of allTags) {
      paths.push({
        params: {
          lang,
          slug: tagToSlug(tag),
        },
        props: {
          tag,
          gags: allGags.filter((gag: GagEntry) => {
            return gag.data.tags.includes(tag);
          }),
        },
      });
    }
  }

  return paths;
}

interface Props {
  tag: string;
  gags: GagEntry[];
}

const { tag, gags } = Astro.props;
const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);

const t = useTranslations(lang);

// SEO를 위한 메타 데이터
const pageTitle = t(`#${tag} 개그 모음`, `#${tag} Puns`);
const pageDescription = t(
  `총 ${gags.length}개의 개그`,
  `${gags.length} puns in total`,
);
---

<Layout
  title={pageTitle}
  description={pageDescription}
  currentPage="tag"
  lang={lang}
>
  <div class="container mx-auto px-4 py-8">
    <!-- 태그 헤더 -->
    <section class="mb-8" data-pagefind-ignore>
      <h1 class="text-foreground mb-2 text-3xl font-bold">#{tag}</h1>
      <p class="text-muted-foreground">
        {t(`이 태그가 포함된 개그 `, ``)}
        <strong>{gags.length}</strong>{t(`개`, ` puns with this tag`)}
      </p>
    </section>

    <!-- 개그 목록 -->
    <section class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
      {gags.map((gag: GagEntry) => <ListCard gag={gag} lang={lang} />)}
    </section>
  </div>
</Layout>
