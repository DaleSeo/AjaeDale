---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Heading from "../../components/Heading.astro";
import ListCard from "../../components/ListCard.astro";
import { sortGagsByPopularity } from "../../utils/popularityUtils";
import { enrichGagsWithLikes } from "../../utils/discussionsApi";
import {
  getStaticPathsLocales,
  normalizeLang,
  useTranslations,
} from "../../utils/i18n";

export async function getStaticPaths() {
  return getStaticPathsLocales().map((lang) => ({
    params: { lang },
  }));
}

type GagEntry = CollectionEntry<"gags">;

const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);

const t = useTranslations(lang);

const allGags = await getCollection("gags", ({ data }: GagEntry) => {
  return data.published === true;
});

// GitHub Discussionsì—ì„œ likes ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ê°œê·¸ì— ì¶”ê°€
const gagsWithLikesData = await enrichGagsWithLikes(allGags);

// likes ìˆ˜ì— ë”°ë¼ ì •ë ¬
const popularGags = sortGagsByPopularity(gagsWithLikesData);

// í‘œì‹œí•  ê°œê·¸ ì„ íƒ: í•­ìƒ 12ê°œ ê³ ì •
const displayGags = popularGags.slice(0, 12);
---

<Layout
  title={t("ì¸ê¸° ê°œê·¸", "Popular Puns")}
  description={t("ê°€ì¥ ë§ì€ ì‚¬ë‘ì„ ë°›ê³  ìˆëŠ” ê°œê·¸ë“¤", "The most loved puns")}
  currentPage="popular"
  lang={lang}
>
  <!-- í—¤ë” ì„¹ì…˜ -->
  <section class="from-primary/5 to-background bg-gradient-to-b px-4 py-12">
    <div class="container mx-auto max-w-4xl">
      <Heading
        title={`ğŸ”¥ ${t("ì¸ê¸° ê°œê·¸", "Popular Puns")}`}
        subtitle={t(
          "ê°€ì¥ ëœ¨ê±°ìš´ ë°˜ì‘ì„ ì–»ê³  ìˆëŠ” ê°œê·¸ë“¤",
          "The hottest puns getting the most reactions",
        )}
      />
    </div>
  </section>

  <!-- ì¸ê¸° ê°œê·¸ ì„¹ì…˜ -->
  <section class="px-4 py-8">
    <div class="container mx-auto max-w-6xl">
      <!-- TOP 3 ì„¹ì…˜ -->
      {
        displayGags.length > 0 && (
          <div class="from-primary/10 to-primary/5 mb-8 rounded-2xl bg-gradient-to-r p-6">
            <div class="mb-4">
              <h2 class="text-foreground flex items-center text-xl font-bold">
                ğŸ† {t("ì´ë²ˆ ì£¼ TOP 3", "Top 3 This Week")}
              </h2>
            </div>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
              {displayGags.slice(0, 3).map((gag, index) => (
                <div class="group relative">
                  {/* ìˆœìœ„ ë°°ì§€ */}
                  <div class="bg-primary text-primary-foreground absolute -top-3 -left-3 z-10 flex h-11 w-11 items-center justify-center rounded-full text-base font-bold">
                    {index + 1}
                  </div>

                  {/* ì¹´ë“œ ê°•ì¡° íš¨ê³¼ */}
                  <div class="relative">
                    {index === 0 && (
                      <div class="absolute -inset-0.5 rounded-lg bg-gradient-to-r from-yellow-400/30 to-orange-400/30 opacity-50 blur transition-opacity group-hover:opacity-75" />
                    )}
                    <div class="relative">
                      <ListCard gag={gag} lang={lang} />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      }

      <!-- ë‚˜ë¨¸ì§€ ê°œê·¸ë“¤ -->
      {
        displayGags.length > 3 && (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
            {displayGags.slice(3).map((gag, index) => (
              <div class="relative">
                <div class="absolute -top-3 -left-3 z-10 flex h-10 w-10 items-center justify-center rounded-full bg-gray-500 text-sm font-bold text-white">
                  {index + 4}
                </div>
                <ListCard gag={gag} lang={lang} />
              </div>
            ))}
          </div>
        )
      }
    </div>
  </section>
</Layout>
