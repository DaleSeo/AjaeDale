---
import Layout from "../../layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import {
  useTranslations,
  getStaticPathsLocales,
  normalizeLang,
} from "../../i18n/utils";

export async function getStaticPaths() {
  return getStaticPathsLocales().map((lang) => ({
    params: { lang },
  }));
}

type GagEntry = CollectionEntry<"gags">;

const { lang: langParam } = Astro.params;
const lang = normalizeLang(langParam);
const t = useTranslations(lang);

// ëª¨ë“  íƒœê·¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
const allGags = await getCollection("gags", ({ data }: GagEntry) => {
  return data.published === true;
});

const allTags = new Set<string>();
allGags.forEach((gag: GagEntry) => {
  gag.data.tags.forEach((tag: string) => {
    allTags.add(tag);
  });
});

const sortedTags = Array.from(allTags).sort();

// í˜ì´ì§€ ë©”íƒ€ ì •ë³´
const title = t("submit.title");
const description = t("submit.description");
---

<Layout title={title} description={description} currentPage="submit">
  <section class="px-4 py-16">
    <div class="container mx-auto max-w-2xl">
      <!-- í˜ì´ì§€ í—¤ë” -->
      <div class="mb-12 text-center">
        <h1 class="text-foreground mb-4 text-3xl font-bold">ğŸ“ {title}</h1>
        <p class="text-muted-foreground text-lg">
          {description}
        </p>
      </div>

      <!-- ì œì¶œ í¼ -->
      <div class="bg-card border-border rounded-xl border p-8">
        <form id="submit-form" class="space-y-6">
          <!-- ê°œê·¸ ì§ˆë¬¸ -->
          <div>
            <label
              for="title"
              class="text-foreground mb-2 block text-sm font-medium"
            >
              ê°œê·¸ ì§ˆë¬¸ <span class="text-destructive">*</span>
            </label>
            <input
              type="text"
              id="title"
              name="title"
              required
              placeholder="ì˜ˆ: ì™•ì´ ë„˜ì–´ì§€ë©´?"
              class="border-border focus:ring-primary bg-background w-full rounded-md border px-3 py-2 focus:border-transparent focus:ring-2 focus:outline-none"
            />
            <p class="text-muted-foreground mt-1 text-xs">
              ì§ˆë¬¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
          </div>

          <!-- ê°œê·¸ ë‹µë³€ -->
          <div>
            <label
              for="body"
              class="text-foreground mb-2 block text-sm font-medium"
            >
              ê°œê·¸ ë‹µë³€ <span class="text-destructive">*</span>
            </label>
            <input
              type="text"
              id="body"
              name="body"
              required
              placeholder="ì˜ˆ: í‚¹ì½©"
              class="border-border focus:ring-primary bg-background w-full rounded-md border px-3 py-2 focus:border-transparent focus:ring-2 focus:outline-none"
            />
            <p class="text-muted-foreground mt-1 text-xs">
              ì¬ì¹˜ìˆëŠ” ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
          </div>

          <!-- íƒœê·¸ -->
          <div>
            <label
              for="tags"
              class="text-foreground mb-2 block text-sm font-medium"
            >
              íƒœê·¸ <span class="text-muted-foreground">(ì„ íƒì‚¬í•­)</span>
            </label>
            <input
              type="text"
              id="tags"
              name="tags"
              placeholder="ì˜ˆ: ì™•, ë™ë¬¼"
              class="border-border focus:ring-primary bg-background w-full rounded-md border px-3 py-2 focus:border-transparent focus:ring-2 focus:outline-none"
            />
            <p class="text-muted-foreground mt-1 text-xs">
              ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ íƒœê·¸ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="mt-2">
              <p class="text-muted-foreground mb-1 text-xs">ì¸ê¸° íƒœê·¸:</p>
              <div class="flex flex-wrap gap-1">
                {
                  sortedTags.slice(0, 10).map((tag) => (
                    <button
                      type="button"
                      class="tag-suggestion bg-muted text-muted-foreground hover:bg-primary/10 hover:text-primary rounded px-2 py-1 text-xs transition-colors"
                      data-tag={tag}
                    >
                      #{tag}
                    </button>
                  ))
                }
              </div>
            </div>
          </div>

          <!-- ì‘ì„±ì -->
          <div>
            <label
              for="author"
              class="text-foreground mb-2 block text-sm font-medium"
            >
              ì‘ì„±ì ë‹‰ë„¤ì„ <span class="text-destructive">*</span>
            </label>
            <input
              type="text"
              id="author"
              name="author"
              required
              placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
              class="border-border focus:ring-primary bg-background w-full rounded-md border px-3 py-2 focus:border-transparent focus:ring-2 focus:outline-none"
              maxlength="20"
            />
            <p class="text-muted-foreground mt-1 text-xs">
              ìµœëŒ€ 20ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
          </div>

          <!-- ì œì¶œ ë²„íŠ¼ -->
          <div class="pt-4">
            <button
              type="submit"
              class="bg-primary text-primary-foreground hover:bg-primary/90 w-full rounded-lg px-6 py-3 font-medium transition-colors"
            >
              ê°œê·¸ ì œì¶œí•˜ê¸°
            </button>
          </div>
        </form>

        <!-- ì„±ê³µ ë©”ì‹œì§€ -->
        <div
          id="success-message"
          class="mt-6 hidden rounded-lg border border-green-200 bg-green-50 p-4"
        >
          <div class="flex items-center">
            <div class="mr-3 text-xl text-green-600">âœ…</div>
            <div>
              <h3 class="font-medium text-green-800">ì œì¶œ ì™„ë£Œ!</h3>
              <p class="text-sm text-green-700">
                ê°œê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ì‚¬ì´íŠ¸ì— ì¶”ê°€ë©ë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ì œì¶œ ê°€ì´ë“œë¼ì¸ -->
      <div class="bg-muted/50 mt-8 rounded-xl p-6">
        <h3 class="text-foreground mb-4 text-lg font-semibold">
          ğŸ“‹ ì œì¶œ ê°€ì´ë“œë¼ì¸
        </h3>
        <ul class="text-muted-foreground space-y-2">
          <li class="flex items-start">
            <span class="text-primary mr-2">â€¢</span>
            ê±´ì „í•˜ê³  ì¬ë¯¸ìˆëŠ” ì•„ì¬ê°œê·¸ë§Œ ì œì¶œí•´ì£¼ì„¸ìš”
          </li>
          <li class="flex items-start">
            <span class="text-primary mr-2">â€¢</span>
            íƒ€ì¸ì˜ ì €ì‘ê¶Œì„ ì¹¨í•´í•˜ì§€ ì•ŠëŠ” ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”
          </li>
          <li class="flex items-start">
            <span class="text-primary mr-2">â€¢</span>
            ìš•ì„¤ì´ë‚˜ ë¹„ë°©, ì„ ì •ì ì¸ ë‚´ìš©ì€ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
          </li>
          <li class="flex items-start">
            <span class="text-primary mr-2">â€¢</span>
            ì œì¶œëœ ê°œê·¸ëŠ” ê²€í†  í›„ 1-3ì¼ ë‚´ì— ì‚¬ì´íŠ¸ì— ë°˜ì˜ë©ë‹ˆë‹¤
          </li>
        </ul>
      </div>

      <!-- ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
      <div class="mt-8 text-center">
        <a
          href="/"
          class="border-border hover:bg-accent inline-block rounded-lg border px-6 py-3 transition-colors"
        >
          â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("submit-form") as HTMLFormElement;
    const successMessage = document.getElementById(
      "success-message",
    ) as HTMLElement;
    const tagsInput = document.getElementById("tags") as HTMLInputElement;

    // íƒœê·¸ ì œì•ˆ ë²„íŠ¼ í´ë¦­ ì‹œ
    document.querySelectorAll(".tag-suggestion").forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.getAttribute("data-tag");
        if (tag && tagsInput) {
          const currentTags = tagsInput.value
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t);
          if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            tagsInput.value = currentTags.join(", ");
          }
        }
      });
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      // í¼ ë°ì´í„° ìˆ˜ì§‘
      const formData = new FormData(form);
      const title = formData.get("title") as string;
      const body = formData.get("body") as string;
      const tags = formData.get("tags") as string;
      const author = formData.get("author") as string;

      // ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬
      if (!title || title.length < 2) {
        alert("ê°œê·¸ ì§ˆë¬¸ì„ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!body || body.length < 1) {
        alert("ê°œê·¸ ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!author || author.length < 1) {
        alert("ì‘ì„±ì ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // íƒœê·¸ ì²˜ë¦¬
      const tagList = tags
        ? tags
            .split(",")
            .map((t) => t.trim())
            .filter((t) => t)
        : [];

      // ì—¬ê¸°ì„œ ì‹¤ì œë¡œëŠ” ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•´ì•¼ í•˜ì§€ë§Œ,
      // í˜„ì¬ëŠ” ë°ëª¨ ë²„ì „ì´ë¯€ë¡œ ì„±ê³µ ë©”ì‹œì§€ë§Œ í‘œì‹œ
      console.log("ì œì¶œëœ ê°œê·¸:", {
        title,
        body,
        tags: tagList,
        author,
        date: new Date().toISOString().split("T")[0],
      });

      // í¼ ìˆ¨ê¸°ê¸° ë° ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      form.style.display = "none";
      successMessage.classList.remove("hidden");

      // 3ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (í¼ ì´ˆê¸°í™”)
      setTimeout(() => {
        window.location.reload();
      }, 3000);
    });
  });
</script>
